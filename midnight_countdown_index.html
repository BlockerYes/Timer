<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Local Weather Alerts</title>
  <style>
    :root{
      --bg1:#071127;--bg2:#071a2a;--card:#0b1320;--accent:#60a5fa;--muted:rgba(255,255,255,0.65);
    }
    html,body{height:100%;}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef8;display:flex;align-items:center;justify-content:center;padding:24px}
    .container{width:min(980px,96vw);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:14px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.6);}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:1.25rem;color:#dbeafe}
    .subtitle{margin:4px 0 0 0;color:var(--muted);font-size:0.92rem}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:none;padding:8px 12px;border-radius:8px;color:#04233b;font-weight:600;cursor:pointer}
    .small{font-size:0.85rem;color:var(--muted)}
    main{margin-top:16px}
    .status{margin:8px 0;color:var(--muted)}
    .alerts{display:grid;grid-template-columns:1fr;gap:10px}
    .alert{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;border-left:6px solid transparent}
    .alert .row{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .event{font-weight:700;margin:0}
    .meta{font-size:0.86rem;color:var(--muted);margin-top:6px}
    .desc{margin-top:8px;white-space:pre-wrap}
    .severity-Severe{border-left-color:#ff6b6b}
    .severity-Moderate{border-left-color:#f59e0b}
    .severity-Minor{border-left-color:#60a5fa}
    .no-alerts{padding:18px;background:rgba(255,255,255,0.01);border-radius:8px;color:var(--muted)}
    .manual{margin-top:12px;display:flex;gap:8px;align-items:center}
    input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
    footer{margin-top:14px;font-size:0.82rem;color:var(--muted)}
    @media(min-width:720px){.alerts{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Local Weather Alerts</h1>
        <div class="subtitle">Uses your device location to show active National Weather Service alerts for your exact point.</div>
      </div>
      <div class="controls">
        <button id="refreshBtn">Refresh</button>
        <div class="small">Auto-refresh: <span id="autoInterval">5m</span></div>
      </div>
    </header>

    <main>
      <div class="status" id="status">Click “Allow” in the browser to share location, or enter coordinates / ZIP below.</div>

      <div class="manual">
        <input id="manual-input" placeholder="Enter lat,lng or ZIP (e.g. 42.33,-83.05 or 48126)" />
        <button id="manualBtn">Go</button>
      </div>

      <section id="alertsContainer" style="margin-top:12px">
        <div class="no-alerts">No data yet.</div>
      </section>
    </main>

    <footer>Data from the NWS / weather.gov API. This page is static — you can host it anywhere (GitHub Pages, Netlify, Vercel).</footer>
  </div>

<script>
async function getAlertsForPoint(lat, lon){
  const url = `https://api.weather.gov/alerts/active?point=${lat},${lon}`;
  const res = await fetch(url);
  if(!res.ok) throw new Error('NWS API error: '+res.status);
  return res.json();
}

function formatDate(iso){
  if(!iso) return '—';
  try{ const d=new Date(iso); return d.toLocaleString(); }catch(e){return iso}
}

function renderAlerts(data){
  const container = document.getElementById('alertsContainer');
  container.innerHTML = '';
  const features = data && data.features ? data.features : [];
  if(!features.length){
    container.innerHTML = '<div class="no-alerts">No active alerts for your location.</div>';
    return;
  }
  const list = document.createElement('div'); list.className='alerts';
  features.forEach(f=>{
    const props = f.properties || {};
    const el = document.createElement('article'); el.className='alert severity-'+(props.severity||'Unknown');
    el.innerHTML = `
      <div class="row">
        <div>
          <div class="event">${escapeHtml(props.event||'Untitled alert')}</div>
          <div class="meta">${props.headline ? escapeHtml(props.headline) : ''}</div>
        </div>
        <div class="small">${escapeHtml(props.severity||'')}</div>
      </div>
      <div class="meta">Effective: ${formatDate(props.effective)} — Expires: ${formatDate(props.expires)}</div>
      <div class="desc">${props.description ? escapeHtml(props.description) : ''}
      ${props.instruction ? '<hr/>' + escapeHtml(props.instruction) : ''}
      </div>
    `;
    list.appendChild(el);
  });
  container.appendChild(list);
}

function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

async function updateForLatLon(lat, lon){
  const status = document.getElementById('status');
  status.textContent = `Loading alerts for ${lat.toFixed(4)}, ${lon.toFixed(4)}...`;
  try{
    const data = await getAlertsForPoint(lat, lon);
    status.textContent = `Showing ${data.features.length} active alert(s) for ${lat.toFixed(4)}, ${lon.toFixed(4)}.`;
    renderAlerts(data);
  }catch(e){
    status.textContent = 'Error fetching alerts: '+e.message;
    document.getElementById('alertsContainer').innerHTML = '<div class="no-alerts">Unable to load alerts.</div>';
  }
}

function tryGeolocation(){
  if(!navigator.geolocation){ document.getElementById('status').textContent = 'Geolocation not supported. Enter coordinates or ZIP.'; return; }
  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude; const lon = pos.coords.longitude;
    updateForLatLon(lat, lon);
  }, err=>{
    document.getElementById('status').textContent = 'Location denied or unavailable. Enter coordinates or ZIP.';
  }, {timeout:10000});
}

// Simple ZIP -> coord fallback using Zippopotam (no API key)
async function zipToLatLon(zip){
  try{
    const res = await fetch(`https://api.zippopotam.us/us/${zip}`);
    if(!res.ok) throw new Error('ZIP lookup failed');
    const data = await res.json();
    const place = data.places && data.places[0];
    return {lat: parseFloat(place.latitude), lon: parseFloat(place.longitude)};
  }catch(e){throw e}
}

// Manual input handler
document.getElementById('manualBtn').addEventListener('click', async ()=>{
  const v = document.getElementById('manual-input').value.trim();
  if(!v) return;
  if(/^[0-9.+-]+\s*,\s*[0-9.+-]+$/.test(v)){
    const [lat,lon]=v.split(',').map(s=>parseFloat(s.trim()));
    updateForLatLon(lat,lon);
  }else if(/^\d{5}$/.test(v)){
    try{ const c = await zipToLatLon(v); updateForLatLon(c.lat,c.lon);}catch(e){document.getElementById('status').textContent='ZIP lookup failed.'}
  }else{
    document.getElementById('status').textContent='Enter coordinates like 42.33,-83.05 or 5-digit US ZIP.';
  }
});

// Refresh button
document.getElementById('refreshBtn').addEventListener('click', ()=>{ tryGeolocation(); });

// Auto-refresh every 5 minutes
setInterval(()=>{ tryGeolocation(); }, 5*60*1000);

// Initial attempt
tryGeolocation();
</script>
</body>
</html>
