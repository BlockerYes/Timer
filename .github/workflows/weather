<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Michigan + Great Lakes Weather Alerts</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<style>
body {
    background-color: #111;
    color: #fff;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
}
h1 {
    text-align: center;
    margin-bottom: 20px;
}

/* ---------------- ALERT CARD ---------------- */
.alert-card {
    background: linear-gradient(135deg, #222, #333);
    border-radius: 12px;
    padding: 10px 15px;
    margin-bottom: 12px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.5);
    border-left: 6px solid #FFA500;
    cursor: pointer;
    overflow: hidden;
    transition: all 0.3s ease;
    max-height: 80px; /* Compact height */
    position: relative;
}
.alert-card.expanded {
    max-height: 1000px; /* enough to expand fully */
    transition: all 0.5s ease;
}

/* Header: Event + Severity */
.alert-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.alert-header h2 {
    margin: 0;
    font-size: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
}
.severity {
    font-weight: bold;
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 12px;
    color: #000;
    background: #FFA500;
}

/* Progress bar */
.progress-container {
    background: #333;
    border-radius: 10px;
    height: 20px;
    width: 100%;
    margin: 5px 0;
    position: relative;
}
.progress-bar {
    height: 100%;
    border-radius: 10px;
    width: 0%;
    transition: width 0.5s linear;
}
.timer-text {
    position: absolute;
    width: 100%;
    text-align: center;
    top: 0;
    line-height: 20px;
    font-size: 12px;
    font-weight: bold;
    color: #fff;
    background: rgba(0,0,0,0.5); /* semi-transparent overlay for readability */
    border-radius: 10px;
    pointer-events: none;
}

/* Grid for info */
.grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 5px 15px;
    font-size: 13px;
    margin-top: 10px;
}

/* Parameters box (hidden by default) */
.parameters {
    background: #333;
    padding: 8px;
    border-radius: 6px;
    margin-top: 5px;
    font-size: 12px;
    overflow-x: auto;
    display: none;
}

/* Description box (hidden by default) */
.description {
    font-size: 13px;
    margin-top: 8px;
    display: none;
}

/* Expand icon */
.expand-icon {
    font-size: 14px;
    transition: transform 0.3s;
}
.alert-card.expanded .expand-icon {
    transform: rotate(180deg);
}

/* Responsive grid */
@media (max-width: 600px) {
    .grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<h1>Michigan + Great Lakes Weather Alerts</h1>
<div id="alerts-container">Loading alerts...</div>

<script>
const ALERT_ICONS = {
    "Tornado": "ðŸŒªï¸",
    "Thunderstorm": "â›ˆï¸",
    "Severe Thunderstorm": "â›ˆï¸",
    "Flash Flood": "ðŸŒŠ",
    "Flood": "ðŸŒŠ",
    "Winter": "â„ï¸",
    "Fire": "ðŸ”¥",
    "Hurricane": "ðŸŒ€",
    "Small Craft": "ðŸš¤",
    "Marine": "ðŸ›¥ï¸",
    "Other": "âš ï¸"
};

const ALERT_COLORS = {
    "Extreme": "#FF0000",
    "Severe": "#FFA500",
    "Moderate": "#FFFF00",
    "Minor": "#00FF00",
    "Unknown": "#AAAAAA"
};

function getSeverityColor(severity) {
    return ALERT_COLORS[severity] || "#FFA500";
}

function getAlertIcon(event) {
    for (let key in ALERT_ICONS) {
        if (event.toLowerCase().includes(key.toLowerCase())) return ALERT_ICONS[key];
    }
    return ALERT_ICONS["Other"];
}

function msToTime(duration) {
    let seconds = Math.floor(duration / 1000);
    let minutes = Math.floor(seconds / 60);
    let hours = Math.floor(minutes / 60);
    seconds %= 60;
    minutes %= 60;
    return `${hours}h ${minutes}m ${seconds}s`;
}

function toggleExpand(card) {
    card.classList.toggle("expanded");
    const desc = card.querySelector(".description");
    const params = card.querySelector(".parameters");
    if (card.classList.contains("expanded")) {
        desc.style.display = "block";
        params.style.display = "block";
    } else {
        desc.style.display = "none";
        params.style.display = "none";
    }
}

function updateProgressBar(progressBar, timerText, sent, expires) {
    const endTime = new Date(expires).getTime();
    const startTime = new Date(sent).getTime();

    function update() {
        const now = new Date().getTime();
        let percent = 0;
        let remaining = 0;

        if (now >= endTime) {
            percent = 0;
            remaining = 0;
            timerText.innerText = "Expired";
        } else if (now <= startTime) {
            percent = 100;
            remaining = endTime - startTime;
            timerText.innerText = msToTime(remaining);
        } else {
            remaining = endTime - now;
            percent = Math.round((remaining / (endTime - startTime)) * 100);
            timerText.innerText = msToTime(remaining);
        }

        progressBar.style.width = percent + "%";

        // Color coding
        if (percent > 66) progressBar.style.background = "#00ff00";
        else if (percent > 33) progressBar.style.background = "#ffff00";
        else progressBar.style.background = "#ff0000";

        requestAnimationFrame(update);
    }
    update();
}

function extractWindInfo(text) {
    if (!text) return "";

    const t = text.toLowerCase();
    let sustained = 0;
    let gust = 0;
    let unit = "";

    // Match sustained wind ranges: "10 to 20 kt", "15-25 mph"
    const sustainedRegex = /(?:^|\s|from|southeast|south|north|east|west)?\s*(\d+)\s*(?:to|-)?\s*(\d+)?\s*(knots?|kt|mph)?/g;
    // Match gusts: "gusts up to 30 kt", "gusts 25 mph"
    const gustRegex = /gusts? (?:up to )?(\d+)\s*(knots?|kt|mph)?/g;

    let match;

    // Check sustained winds
    while ((match = sustainedRegex.exec(t)) !== null) {
        const v1 = parseInt(match[1]);
        const v2 = match[2] ? parseInt(match[2]) : v1;
        const u = match[3] ? match[3] : "";
        if (v2 > sustained) sustained = v2;
        if (!unit && u) unit = u.includes("knot") ? "kt" : u.includes("mph") ? "mph" : "kt";
    }

    // Check gusts
    while ((match = gustRegex.exec(t)) !== null) {
        const g = parseInt(match[1]);
        const u = match[2] ? match[2] : unit;
        if (g > gust) gust = g;
        if (!unit && u) unit = u.includes("knot") ? "kt" : u.includes("mph") ? "mph" : "kt";
    }

    if (sustained || gust) {
        let result = " (";
        if (sustained) result += `Sustained ${sustained} ${unit}`;
        if (gust) result += sustained ? `, Gusts ${gust} ${unit}` : `Gusts ${gust} ${unit}`;
        result += ")";
        return result;
    }

    return "";
}



async function fetchAlerts() {
    const container = document.getElementById("alerts-container");
    try {
        const response = await fetch("https://api.weather.gov/alerts/active?area=MI,LM,LE,LH,LC,LS", {
            headers: { "User-Agent": "WeatherHTML/1.0" }
        });
        const data = await response.json();

        if (!data.features || data.features.length === 0) {
            container.innerHTML = "<p>âœ… No active alerts</p>";
            return;
        }

        container.innerHTML = "";

        data.features.forEach((feature) => {
            const p = feature.properties;
            const event = p.event || "";
            const headline = p.headline || "";
            const description = p.description || "";
            const windInfo = extractWindInfo((p.headline || "") + " " + description);
            const severity = p.severity || "Unknown";
            const sent = p.sent || "";
            const expires = p.expires || "";
            const parameters = p.parameters || {};

            const alertCard = document.createElement("div");
            alertCard.className = "alert-card";
            alertCard.style.borderLeftColor = getSeverityColor(severity);

            alertCard.innerHTML = `
                <div class="alert-header">
                    <h2>${getAlertIcon(event)} ${event}${windInfo}</h2>
                    <span class="severity">${severity}</span>
                    <i class="fas fa-chevron-down expand-icon"></i>
                </div>
                <div class="progress-container">
                    <div class="progress-bar"></div>
                    <div class="timer-text"></div>
                </div>
                <p class="description"><strong>Description:</strong> ${description}</p>
                <div class="grid">
                    <div><strong>Status:</strong> ${p.status || ""}</div>
                    <div><strong>Message Type:</strong> ${p.messageType || ""}</div>
                    <div><strong>Category:</strong> ${p.category || ""}</div>
                    <div><strong>Certainty:</strong> ${p.certainty || ""}</div>
                    <div><strong>Urgency:</strong> ${p.urgency || ""}</div>
                    <div><strong>Sender:</strong> ${p.sender || ""}</div>
                    <div><strong>Sender Name:</strong> ${p.senderName || ""}</div>
                    <div><strong>Sent:</strong> ${sent}</div>
                    <div><strong>Expires:</strong> ${expires}</div>
                </div>
                <div class="parameters">
                    ${Object.keys(parameters).map(k => {
                        const v = Array.isArray(parameters[k]) ? parameters[k].join(", ") : parameters[k];
                        return `<div><strong>${k}:</strong> ${v}</div>`;
                    }).join("")}
                </div>
            `;

            alertCard.querySelector(".alert-header").addEventListener("click", () => toggleExpand(alertCard));

            container.appendChild(alertCard);

            // Progress bar & timer
            const progressBar = alertCard.querySelector(".progress-bar");
            const timerText = alertCard.querySelector(".timer-text");
            updateProgressBar(progressBar, timerText, sent, expires);
        });
    } catch (err) {
        console.error(err);
        container.innerHTML = "<p>[ERROR] Failed to fetch alerts</p>";
    }
}

// Initial fetch + periodic update
fetchAlerts();
setInterval(fetchAlerts, 15000);
</script>
</body>
</html>
